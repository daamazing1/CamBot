<!doctype html>
<html>
    <head>
        <title>CamBot Controller</title>
        <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="/socket.io/socket.io.js"></script>

        <script type="text/javascript">
            var socket = io();
            //form ada fruit library to keep consistant
            var forward = 1;
            var backward = 2;
            var release = 4;

            var hasGP = false;
            var repGP;

            function canGame(){
                return "getGamepads" in navigator;
            }

            function reportOnGamepad(){
                var gp = navigator.getGamepads()[0];
                var html = "id: " + gp.id + "<br />";

                for(var i=0,j=gp.axes.length;i<j;i+=2){
                    html += "Stick " + (Math.ceil(i/2)+1) + ": " + gp.axes[i] + "," + gp.axes[i+1] + "<br />";
                }

                var mSpeed = Math.floor(Math.abs(gp.axes[1] * 255)); 
                //if(mSpeed>50){
                    socket.emit('motor',{
                        motor:1,
                        command:(gp.axes[1]>0?forward:gp.axes[1]<0?backward:release),
                        speed:Math.floor(Math.abs(gp.axes[1] * 255))
                    });
                //}
                
                mSpeed = Math.floor(Math.abs(gp.axes[3] * 255));
                //if(mSpeed>50){
                    socket.emit('motor',{
                        motor:2,
                        command:(gp.axes[3]>0?forward:gp.axes[3]<0?backward:release),
                        speed:Math.floor(Math.abs(gp.axes[3] * 255))
                     });
                //}



                $("#gamepadDisplay").html(html);
            }

            $(function(){
                if(canGame()){
                    var prompt = "To begin using your gamepad, connect it and press any button";
                    $("gamepadPrompt").text(prompt);

                    $(window).on("gamepadconnected", function(){
                        hasGP = true;
                        $("#gamepadPrompt").html("Gamepad connected!");
                        console.log("connection event");
                        repGP = window.setInterval(reportOnGamepad,700);
                    });
                    
                    $(window).on("gamepaddisconnected", function(){
                        console.log("disconnection event");
                        $("#gamepadPrompt").text(prompt);
                        window.clearInterval(repGP);
                    });


                    //setup an interval for Chrome
                    var checkGP = window.setInterval(function(){
                        console.log('checkGP');
                        if(navigator.getGamepads()[0]){
                            if(!hasGP){
                                $(window).trigger("gamepadconnected");
                            }
                            window.clearInterval(checkGP);
                        }
                    }, 500);
                };
            });
        </script>
    </head>
    <body>
        <div id="gamepadPrompt"></div>
        <div id="gamepadDisplay"></div>

        <button id="forward">Forward</button>
        <button id="reverse">Reverse</button>
        <button id="left">Left</button>
        <button id="right">Right</button>
        <button id="stop">Stop</button>
    </body>
</html>
